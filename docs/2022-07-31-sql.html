<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="github-markdown.css" />
    <title>haunt98 posts</title>
  </head>
  <style>
    .markdown-body {
      box-sizing: border-box;
      min-width: 200px;
      max-width: 980px;
      margin: 0 auto;
      padding: 45px;
      font-family:
        Google Sans Flex,
        Sudo UI Var,
        Inter,
        SF Pro,
        sans-serif;
      font-weight: 500;
      --fontStack-monospace: Iosevka Pacman, Jetbrains Mono, SF Mono, monospace;
    }

    @media (max-width: 767px) {
      .markdown-body {
        padding: 15px;
      }
    }
  </style>
  <body class="markdown-body">
    <h2>
      <a href="index.html"><code>~</code></a>
    </h2>
    <div class="markdown-heading">
      <h1 class="heading-element">SQL</h1>
      <a
        id="user-content-sql"
        class="anchor"
        aria-label="Permalink: SQL"
        href="#sql"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <p>
      This guide is not kind of guide which cover all cases. Just my little
      tricks when I work with SQL.
    </p>
    <div class="markdown-heading">
      <h2 class="heading-element">Primary key</h2>
      <a
        id="user-content-primary-key"
        class="anchor"
        aria-label="Permalink: Primary key"
        href="#primary-key"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <ul>
      <li>Don't use database auto increment</li>
      <li>Use UUIDv7 (sortable) instead of UUIDv4 (completely random)</li>
    </ul>
    <div class="markdown-heading">
      <h2 class="heading-element">Timestamp</h2>
      <a
        id="user-content-timestamp"
        class="anchor"
        aria-label="Permalink: Timestamp"
        href="#timestamp"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <p>
      Don't use MySQL type timestamp, use int64 then pass the timestamp (prefer
      UnixMilli) to avoid date, time, location complex conversion.
    </p>
    <div class="highlight highlight-text-adblock">
      <pre>[Go] time.Time -&gt; t.UnixMilli() -&gt; [Database] int64</pre>
    </div>
    <div class="markdown-heading">
      <h2 class="heading-element">JSON field</h2>
      <a
        id="user-content-json-field"
        class="anchor"
        aria-label="Permalink: JSON field"
        href="#json-field"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <ul>
      <li>
        <p>
          Use MySQL JSON data type for extra field, to avoid adding new column
          in database
        </p>
      </li>
      <li>
        <p>JSON data type is also useful for dumping request, response data.</p>
      </li>
      <li>
        <p>
          Use <code>JSON_CONTAINS_PATH(col, 'one', '$.key')</code> to check json
          field exist or not
        </p>
      </li>
      <li>
        <p>Use <code>col-&gt;'$.key'</code> to get value</p>
      </li>
      <li>
        <p>
          <a
            href="https://dev.mysql.com/doc/refman/5.7/en/json.html"
            rel="nofollow"
            >For MySQL 5.7</a
          >
        </p>
      </li>
      <li>
        <p>
          <a
            href="https://dev.mysql.com/doc/refman/8.0/en/json.html"
            rel="nofollow"
            >For MySQL 8.0</a
          >
        </p>
      </li>
      <li>
        <p>
          <a
            href="https://planetscale.com/blog/indexing-json-in-mysql"
            rel="nofollow"
            >Indexing JSON in MySQL</a
          >
        </p>
      </li>
    </ul>
    <div class="markdown-heading">
      <h2 class="heading-element">Index</h2>
      <a
        id="user-content-index"
        class="anchor"
        aria-label="Permalink: Index"
        href="#index"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <p>
      You should use index for faster query, but not too much. Don't create
      index for every fields in table. Choose wisely!
    </p>
    <p>For example, create index in MySQL:</p>
    <div class="highlight highlight-source-sql">
      <pre><span class="pl-k">CREATE</span> <span class="pl-k">INDEX</span> <span class="pl-en">idx_user_id</span>
<span class="pl-k">ON</span> user_upload (user_id);</pre>
    </div>
    <p>
      If create index inside <code>CREATE TABLE</code>,
      <a href="https://stackoverflow.com/a/1401615" rel="nofollow"
        >prefer <code>INDEX</code> to <code>KEY</code></a
      >:
    </p>
    <div class="highlight highlight-source-sql">
      <pre><span class="pl-k">CREATE</span> <span class="pl-k">TABLE</span> <span class="pl-en">user_upload</span>
(
    id <span class="pl-k">INT</span>(<span class="pl-c1">11</span>) <span class="pl-k">NOT NULL</span>,
    user_id <span class="pl-k">INT</span>(<span class="pl-c1">11</span>) <span class="pl-k">NULL</span> DEFAULT <span class="pl-k">NULL</span>,
    <span class="pl-k">PRIMARY KEY</span> (id),
    INDEX idx_user_id (user_id)
);</pre>
    </div>
    <p>
      If use composite index, order is important, either both are
      <code>DESC</code> or <code>ASC</code>, do not mix:
    </p>
    <div class="highlight highlight-source-sql">
      <pre><span class="pl-k">CREATE</span> <span class="pl-k">INDEX</span> <span class="pl-en">idx_user_id_created_at</span>
<span class="pl-k">ON</span> user_upload (user_id, created_at);

<span class="pl-c"><span class="pl-c">--</span> Bad</span>
<span class="pl-k">SELECT</span> <span class="pl-k">*</span>
<span class="pl-k">FROM</span> user_upload
<span class="pl-k">ORDER BY</span> user_id, created_at <span class="pl-k">DESC</span>;

<span class="pl-c"><span class="pl-c">--</span> Good</span>
<span class="pl-k">SELECT</span> <span class="pl-k">*</span>
<span class="pl-k">FROM</span> user_upload
<span class="pl-k">ORDER BY</span> user_id, created_at;

<span class="pl-c"><span class="pl-c">--</span> Also good</span>
<span class="pl-k">SELECT</span> <span class="pl-k">*</span>
<span class="pl-k">FROM</span> user_upload
<span class="pl-k">ORDER BY</span> user_id <span class="pl-k">DESC</span>, created_at <span class="pl-k">DESC</span>;</pre>
    </div>
    <p>Use <code>EXPLAIN</code> to check if index is used or not:</p>
    <ul>
      <li>
        <a
          href="https://dev.mysql.com/doc/refman/5.7/en/explain-output.html"
          rel="nofollow"
          >For MySQL 5.7</a
        >
      </li>
      <li>
        <a
          href="https://dev.mysql.com/doc/refman/8.0/en/explain-output.html"
          rel="nofollow"
          >For MySQL 8.0</a
        >
      </li>
    </ul>
    <div class="markdown-heading">
      <h2 class="heading-element">UTF-8</h2>
      <a
        id="user-content-utf-8"
        class="anchor"
        aria-label="Permalink: UTF-8"
        href="#utf-8"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <p>TLDR with MySQL:</p>
    <div class="highlight highlight-source-sql">
      <pre><span class="pl-k">CREATE</span> <span class="pl-k">TABLE</span> <span class="pl-en">ekyc_approved</span>
(
    id <span class="pl-k">varchar</span>(<span class="pl-c1">30</span>) <span class="pl-k">NOT NULL</span>,
    <span class="pl-k">PRIMARY KEY</span> (id),
) ENGINE <span class="pl-k">=</span> InnoDB
  DEFAULT CHARSET <span class="pl-k">=</span> utf8mb4;</pre>
    </div>
    <p>
      Be careful if you edit/cut string which has emoji before saving to
      database.
    </p>
    <div class="markdown-heading">
      <h2 class="heading-element">NULL</h2>
      <a
        id="user-content-null"
        class="anchor"
        aria-label="Permalink: NULL"
        href="#null"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <p>
      If compare with field which can be NULL, remember to check NULL for
      safety.
    </p>
    <div class="highlight highlight-source-sql">
      <pre><span class="pl-c"><span class="pl-c">--</span> field_something can be NULL</span>

<span class="pl-c"><span class="pl-c">--</span> Bad</span>
<span class="pl-k">SELECT</span> <span class="pl-k">*</span>
<span class="pl-k">FROM</span> table
<span class="pl-k">WHERE</span> field_something <span class="pl-k">!=</span> <span class="pl-c1">1</span>

<span class="pl-c"><span class="pl-c">--</span> Good</span>
<span class="pl-k">SELECT</span> <span class="pl-k">*</span>
<span class="pl-k">FROM</span> table
<span class="pl-k">WHERE</span> (field_something IS <span class="pl-k">NULL</span> <span class="pl-k">OR</span> field_something <span class="pl-k">!=</span> <span class="pl-c1">1</span>)</pre>
    </div>
    <p>
      Because <code>NULL</code> is not equal to anything, even
      <code>NULL != NULL</code>, we only can check with <code>IS NULL</code> or
      <code>IS NOT NULL</code>.
    </p>
    <p>This is based on Kleene's TRUE-FALSE-UNKNOWN logic.</p>
    <div class="markdown-heading">
      <h2 class="heading-element"><code>VARCHAR</code> or <code>TEXT</code></h2>
      <a
        id="user-content-varchar-or-text"
        class="anchor"
        aria-label="Permalink: VARCHAR or TEXT"
        href="#varchar-or-text"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <p>
      Prefer <code>VARCHAR</code> if you need to query and of course use index,
      and make sure size of value will never hit the limit. Prefer
      <code>TEXT</code> if you don't care, just want to store something.
    </p>
    <div class="markdown-heading">
      <h2 class="heading-element"><code>LIMIT</code></h2>
      <a
        id="user-content-limit"
        class="anchor"
        aria-label="Permalink: LIMIT"
        href="#limit"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <p>
      Prefer <code>LIMIT 10 OFFSET 5</code> to <code>LIMIT 5, 10</code> to avoid
      misunderstanding.
    </p>
    <div class="markdown-heading">
      <h2 class="heading-element">
        Be super careful when migrate, update database on production and
        online!!!
      </h2>
      <a
        id="user-content-be-super-careful-when-migrate-update-database-on-production-and-online"
        class="anchor"
        aria-label="Permalink: Be super careful when migrate, update database on production and online!!!"
        href="#be-super-careful-when-migrate-update-database-on-production-and-online"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <p>
      Please read docs about online ddl operations before do anything online
      (keep database running the same time update it, for example create index,
      ...)
    </p>
    <ul>
      <li>
        <a
          href="https://dev.mysql.com/doc/refman/5.7/en/innodb-online-ddl-operations.html"
          rel="nofollow"
          >For MySQL 5.7</a
        >,
        <a
          href="https://dev.mysql.com/doc/refman/5.7/en/innodb-online-ddl-limitations.html"
          rel="nofollow"
          >Limitations</a
        >
      </li>
      <li>
        <a
          href="https://dev.mysql.com/doc/refman/8.0/en/innodb-online-ddl-operations.html"
          rel="nofollow"
          >For MySQL 8.0</a
        >,
        <a
          href="https://dev.mysql.com/doc/refman/8.0/en/innodb-online-ddl-limitations.html"
          rel="nofollow"
          >Limitations</a
        >
      </li>
    </ul>
    <div class="markdown-heading">
      <h2 class="heading-element">Heathcheck</h2>
      <a
        id="user-content-heathcheck"
        class="anchor"
        aria-label="Permalink: Heathcheck"
        href="#heathcheck"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <p>Use <code>SELECT 1</code> to check if database failed yet.</p>
    <div class="markdown-heading">
      <h2 class="heading-element">Tools</h2>
      <a
        id="user-content-tools"
        class="anchor"
        aria-label="Permalink: Tools"
        href="#tools"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <ul>
      <li>
        Use
        <a href="https://github.com/sqlfluff/sqlfluff">sqlfluff/sqlfluff</a> to
        check your SQL.
      </li>
      <li>
        Use <a href="https://github.com/k1LoW/tbls">k1LoW/tbls</a> to grasp your
        database reality :)
      </li>
    </ul>
    <div class="markdown-heading">
      <h2 class="heading-element">Pastebin</h2>
      <a
        id="user-content-pastebin"
        class="anchor"
        aria-label="Permalink: Pastebin"
        href="#pastebin"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <p>
      <a href="https://stackoverflow.com/a/5213364" rel="nofollow"
        >Show index of table</a
      >:
    </p>
    <div class="highlight highlight-source-sql">
      <pre><span class="pl-k">SELECT DISTINCT</span>
    table_name,
    index_name
<span class="pl-k">FROM</span> <span class="pl-c1">information_schema</span>.<span class="pl-c1">statistics</span>;</pre>
    </div>
    <div class="markdown-heading">
      <h2 class="heading-element">Thanks</h2>
      <a
        id="user-content-thanks"
        class="anchor"
        aria-label="Permalink: Thanks"
        href="#thanks"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <ul>
      <li>
        <p>
          <a href="https://use-the-index-luke.com/" rel="nofollow"
            >Use The Index, Luke</a
          >
        </p>
      </li>
      <li>
        <p>
          <a
            href="https://kevin.burke.dev/kevin/reddits-database-has-two-tables/"
            rel="nofollow"
            >Reddit’s database has two tables</a
          >
        </p>
      </li>
      <li>
        <p>
          <a
            href="https://shekhargulati.com/2022/07/08/my-notes-on-gitlabs-postgres-schema-design/"
            rel="nofollow"
            >My Notes on GitLab Postgres Schema Design</a
          >
        </p>
      </li>
      <li>
        <p>
          <a
            href="https://shekhargulati.com/2022/01/08/when-to-use-json-data-type-in-database-schema-design/"
            rel="nofollow"
            >When to use JSON data type in database schema design?</a
          >
        </p>
      </li>
      <li>
        <p>
          <a
            href="https://planetscale.com/blog/how-read-mysql-explains"
            rel="nofollow"
            >How to read MySQL EXPLAINs</a
          >
        </p>
      </li>
      <li>
        <p>
          <a
            href="https://brandur.org/fragments/database-health-check"
            rel="nofollow"
            >Honest health checks that hit the database</a
          >
        </p>
      </li>
      <li>
        <p>
          <a href="https://www.grouparoo.com/blog/varchar-191" rel="nofollow"
            >Why are database columns 191 characters?</a
          >
        </p>
      </li>
      <li>
        <p>
          <a href="https://stackoverflow.com/a/43056611" rel="nofollow"
            >Store UUID v4 in MySQL</a
          >
        </p>
      </li>
      <li>
        <p>
          <a href="https://stackoverflow.com/a/4849030" rel="nofollow"
            >Difference between text and varchar (character varying)</a
          >
        </p>
      </li>
      <li>
        <p>
          <a href="https://stackoverflow.com/q/33889922" rel="nofollow"
            >How to get the number of total results when there is LIMIT in
            query?</a
          >
        </p>
      </li>
      <li>
        <p>
          <a href="https://stackoverflow.com/q/28888375" rel="nofollow"
            >Run a query with a LIMIT/OFFSET and also get the total number of
            rows</a
          >
        </p>
      </li>
      <li>
        <p>
          <a
            href="https://www.depesz.com/2024/12/01/sql-best-practices-dont-compare-count-with-0/"
            rel="nofollow"
            >SQL best practices – don’t compare count with 0</a
          >
        </p>
      </li>
      <li>
        <p>
          <a
            href="https://jirevwe.github.io/sql-nulls-are-weird.html"
            rel="nofollow"
            >SQL NULLs are Weird!</a
          >
        </p>
      </li>
      <li>
        <p>
          <a href="https://www.sqlite.org/nulls.html" rel="nofollow"
            >NULL Handling in SQLite Versus Other Database Engines</a
          >
        </p>
      </li>
    </ul>

    <div>
      <br />Source code is available on
      <a href="https://github.com/haunt98/posts-go">GitHub</a>
    </div>
  </body>
</html>
