<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="github-markdown.css" />
    <title>haunt98 posts</title>
  </head>
  <style>
    .markdown-body {
      box-sizing: border-box;
      min-width: 200px;
      max-width: 980px;
      margin: 0 auto;
      padding: 45px;
      font-family:
        Google Sans Flex,
        Sudo UI Var,
        Inter,
        SF Pro,
        sans-serif;
      font-weight: 500;
      --fontStack-monospace: Iosevka Pacman, Jetbrains Mono, SF Mono, monospace;
    }

    @media (max-width: 767px) {
      .markdown-body {
        padding: 15px;
      }
    }
  </style>
  <body class="markdown-body">
    <h2>
      <a href="index.html"><code>~</code></a>
    </h2>
    <div class="markdown-heading">
      <h1 class="heading-element">Bootstrap Go</h1>
      <a
        id="user-content-bootstrap-go"
        class="anchor"
        aria-label="Permalink: Bootstrap Go"
        href="#bootstrap-go"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <p>
      It is hard to write bootstrap tool to quickly create Go service. So I
      write this guide instead. This is a quick checklist for me every damn time
      I need to write a Go service from scratch. Also, this is my personal
      opinion, so feel free to comment.
    </p>
    <div class="markdown-heading">
      <h2 class="heading-element">Structure</h2>
      <a
        id="user-content-structure"
        class="anchor"
        aria-label="Permalink: Structure"
        href="#structure"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <div class="highlight highlight-text-adblock">
      <pre>
main.go
internal/
    http/
        handler.go
        service.go
        models.go
    grpc/
        handler.go
        models.go
    consumer/
        handler.go
        service.go
        models.go
    service.go
    repository.go
    models.go</pre
      >
    </div>
    <p>
      All codes are inside <code>internal</code>. Because
      <code>internal</code> is magic keyword in Go, you can not import pkg
      inside <code>internal</code>.
    </p>
    <p>There are 3 common handlers:</p>
    <ul>
      <li>
        <code>http/</code> is for public APIs (Android, iOS, ... are clients).
      </li>
      <li>
        <code>grpc/</code> is for internal APIs (other services are clients).
      </li>
      <li>
        <code>consumer/</code> is for consuming messages from queue (Kafka,
        RabbitMQ, ...).
      </li>
    </ul>
    <p>
      For each handler, there are usually 3 layers: <code>handler</code>,
      <code>service</code>, <code>repository</code>:
    </p>
    <ul>
      <li>
        <code>handler</code> interacts directly with gRPC, REST or consumer
        using specific codes (cookies, ...) In case gRPC, there are frameworks
        outside handle for us so we can write logic codes here too. But
        remember, gRPC only.
      </li>
      <li>
        <code>service</code> is where we write logic codes, and only logic codes
        is written here.
      </li>
      <li>
        <code>repository</code> is where we write codes which interacts with
        database/cache like MySQL, Redis, ...
      </li>
      <li>
        <code>models</code> is where we put all request, response, data models.
      </li>
    </ul>
    <p>Location:</p>
    <ul>
      <li>
        <code>handler</code> must exist inside <code>grpc</code>,
        <code>http</code>, <code>consumer</code>.
      </li>
      <li>
        <code>service</code>, <code>repository</code> can exist directly inside
        of <code>internal</code> if both <code>grpc</code>, <code>http</code>,
        <code>consumer</code> has same logic.
      </li>
    </ul>
    <div class="markdown-heading">
      <h2 class="heading-element">Good taste</h2>
      <a
        id="user-content-good-taste"
        class="anchor"
        aria-label="Permalink: Good taste"
        href="#good-taste"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <div class="markdown-heading">
      <h3 class="heading-element">Stop using global var</h3>
      <a
        id="user-content-stop-using-global-var"
        class="anchor"
        aria-label="Permalink: Stop using global var"
        href="#stop-using-global-var"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <p>
      If I see someone using global var, I swear I will shoot them twice in the
      face.
    </p>
    <p>Why?</p>
    <ul>
      <li>Can be edited on runtime</li>
      <li>Not thread safe</li>
      <li>Can not write unit test</li>
    </ul>
    <div class="markdown-heading">
      <h3 class="heading-element">Avoid unsigned type</h3>
      <a
        id="user-content-avoid-unsigned-type"
        class="anchor"
        aria-label="Permalink: Avoid unsigned type"
        href="#avoid-unsigned-type"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <p>
      Just a var can not have negative value, doesn't mean it should use
      <code>uint</code>. Just use <code>int</code> and do not care about
      boundary.
    </p>
    <div class="markdown-heading">
      <h3 class="heading-element">
        Use functional options to init complex struct
      </h3>
      <a
        id="user-content-use-functional-options-to-init-complex-struct"
        class="anchor"
        aria-label="Permalink: Use functional options to init complex struct"
        href="#use-functional-options-to-init-complex-struct"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <div class="highlight highlight-source-go">
      <pre><span class="pl-k">func</span> <span class="pl-s1">main</span>() {
	<span class="pl-s1">s</span> <span class="pl-c1">:=</span> <span class="pl-s1">NewS</span>(<span class="pl-s1">WithA</span>(<span class="pl-c1">1</span>), <span class="pl-s1">WithB</span>(<span class="pl-s">"b"</span>))
	<span class="pl-s1">fmt</span>.<span class="pl-c1">Printf</span>(<span class="pl-s">"%+v<span class="pl-cce">\n</span>"</span>, <span class="pl-s1">s</span>)
}

<span class="pl-k">type</span> <span class="pl-smi">S</span> <span class="pl-k">struct</span> {
	<span class="pl-c1">fieldA</span> <span class="pl-smi">int</span>
	<span class="pl-c1">fieldB</span> <span class="pl-smi">string</span>
}

<span class="pl-k">type</span> <span class="pl-smi">OptionS</span> <span class="pl-k">func</span>(<span class="pl-s1">s</span> <span class="pl-c1">*</span><span class="pl-smi">S</span>)

<span class="pl-k">func</span> <span class="pl-s1">WithA</span>(<span class="pl-s1">a</span> <span class="pl-smi">int</span>) <span class="pl-smi">OptionS</span> {
	<span class="pl-k">return</span> <span class="pl-k">func</span>(<span class="pl-s1">s</span> <span class="pl-c1">*</span><span class="pl-smi">S</span>) {
		<span class="pl-s1">s</span>.<span class="pl-c1">fieldA</span> <span class="pl-c1">=</span> <span class="pl-s1">a</span>
	}
}

<span class="pl-k">func</span> <span class="pl-s1">WithB</span>(<span class="pl-s1">b</span> <span class="pl-smi">string</span>) <span class="pl-smi">OptionS</span> {
	<span class="pl-k">return</span> <span class="pl-k">func</span>(<span class="pl-s1">s</span> <span class="pl-c1">*</span><span class="pl-smi">S</span>) {
		<span class="pl-s1">s</span>.<span class="pl-c1">fieldB</span> <span class="pl-c1">=</span> <span class="pl-s1">b</span>
	}
}

<span class="pl-k">func</span> <span class="pl-s1">NewS</span>(<span class="pl-s1">opts</span> <span class="pl-c1">...</span><span class="pl-smi">OptionS</span>) <span class="pl-c1">*</span><span class="pl-smi">S</span> {
	<span class="pl-s1">s</span> <span class="pl-c1">:=</span> <span class="pl-c1">&amp;</span><span class="pl-smi">S</span>{}
	<span class="pl-k">for</span> <span class="pl-s1">_</span>, <span class="pl-s1">opt</span> <span class="pl-c1">:=</span> <span class="pl-k">range</span> <span class="pl-s1">opts</span> {
		<span class="pl-s1">opt</span>(<span class="pl-s1">s</span>)
	}
	<span class="pl-k">return</span> <span class="pl-s1">s</span>
}</pre>
    </div>
    <p>
      In above example, I construct <code>s</code> with <code>WithA</code> and
      <code>WithB</code> option. No need to pass direct field inside
      <code>s</code>.
    </p>
    <div class="markdown-heading">
      <h3 class="heading-element">
        Use
        <a href="https://pkg.go.dev/sync#WaitGroup" rel="nofollow"
          >sync.WaitGroup</a
        >,
        <a href="https://pkg.go.dev/golang.org/x/sync/errgroup" rel="nofollow"
          >errgroup</a
        >
      </h3>
      <a
        id="user-content-use-syncwaitgroup-errgroup"
        class="anchor"
        aria-label="Permalink: Use sync.WaitGroup, errgroup"
        href="#use-syncwaitgroup-errgroup"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <p>
      If logic involves calling too many APIs, but they are not depend on each
      other. We can fire them parallel :)
    </p>
    <p>
      Use <code>errgroup</code> if you need to cancel all tasks if first error
      is caught. Be super careful with <code>egCtx</code>, should use this
      instead of parent <code>ctx</code> inside <code>eg.Go</code>.
    </p>
    <p>Example:</p>
    <div class="highlight highlight-source-go">
      <pre><span class="pl-s1">eg</span>, <span class="pl-s1">egCtx</span> <span class="pl-c1">:=</span> <span class="pl-s1">errgroup</span>.<span class="pl-c1">WithContext</span>(<span class="pl-s1">ctx</span>)

<span class="pl-s1">eg</span>.<span class="pl-c1">Go</span>(<span class="pl-k">func</span>() <span class="pl-smi">error</span> {
	<span class="pl-c">// Do some thing</span>
	<span class="pl-k">return</span> <span class="pl-c1">nil</span>
})

<span class="pl-s1">eg</span>.<span class="pl-c1">Go</span>(<span class="pl-k">func</span>() <span class="pl-smi">error</span> {
	<span class="pl-c">// Do other thing</span>
	<span class="pl-k">return</span> <span class="pl-c1">nil</span>
})

<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">eg</span>.<span class="pl-c1">Wait</span>(); <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
	<span class="pl-c">// Handle error</span>
}</pre>
    </div>
    <div class="markdown-heading">
      <h3 class="heading-element">
        <a href="https://go.dev/doc/tutorial/generics" rel="nofollow"
          >Generics</a
        >
        with some tricks
      </h3>
      <a
        id="user-content-generics-with-some-tricks"
        class="anchor"
        aria-label="Permalink: Generics with some tricks"
        href="#generics-with-some-tricks"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <p>
      Take value then return pointer, useful with database struct full of
      pointers:
    </p>
    <div class="highlight highlight-source-go">
      <pre><span class="pl-c">// Ptr takes in non-pointer and returns a pointer</span>
<span class="pl-k">func</span> <span class="pl-s1">Ptr</span>[<span class="pl-s1">T</span> <span class="pl-smi">any</span>](<span class="pl-s1">v</span> <span class="pl-smi">T</span>) <span class="pl-c1">*</span><span class="pl-smi">T</span> {
	<span class="pl-k">return</span> <span class="pl-c1">&amp;</span><span class="pl-s1">v</span>
}</pre>
    </div>
    <p>Return zero value:</p>
    <div class="highlight highlight-source-go">
      <pre><span class="pl-k">func</span> <span class="pl-s1">Zero</span>[<span class="pl-s1">T</span> <span class="pl-smi">any</span>]() <span class="pl-smi">T</span> {
  <span class="pl-k">var</span> <span class="pl-s1">zero</span> <span class="pl-smi">T</span>
  <span class="pl-k">return</span> <span class="pl-s1">zero</span>
}</pre>
    </div>
    <div class="markdown-heading">
      <h3 class="heading-element">Modernize style</h3>
      <a
        id="user-content-modernize-style"
        class="anchor"
        aria-label="Permalink: Modernize style"
        href="#modernize-style"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <p>Since go 1.26:</p>
    <ul>
      <li>Use <code>a := new(1)</code></li>
      <li>Use <code>errors.AsType</code> instead of <code>errors.As</code></li>
    </ul>
    <p>Since go 1.24:</p>
    <ul>
      <li>Use <code>os.Root</code> instead of <code>os.Open</code></li>
      <li>Use <code>omitzero</code> instead of <code>omitempty</code></li>
    </ul>
    <p>Since go 1.22:</p>
    <ul>
      <li>Use <code>cmp.Or</code> as fallback mechanism</li>
    </ul>
    <p>Since go 1.21:</p>
    <ul>
      <li>
        Use <code>slices.SortFunc</code> instead of <code>sort.Slice</code>.
      </li>
      <li>
        Use <code>ctx.WithoutCancel</code> to disconnect context from parent.
      </li>
      <li>Use <code>clear(m)</code> to clear map entirely.</li>
    </ul>
    <p>Since go 1.20:</p>
    <ul>
      <li>Use <code>errors.Join</code> for multiple errors.</li>
    </ul>
    <p>Since go 1.18:</p>
    <ul>
      <li>Use <code>any</code> instead of <code>interface{}</code>.</li>
    </ul>
    <p>
      Use
      <a
        href="https://pkg.go.dev/golang.org/x/tools/gopls/internal/analysis/modernize"
        rel="nofollow"
        >gopls/modernize</a
      >
      to modernize code.
    </p>
    <div class="highlight highlight-source-shell">
      <pre>modernize -fix -test ./...</pre>
    </div>
    <div class="markdown-heading">
      <h2 class="heading-element">External libs</h2>
      <a
        id="user-content-external-libs"
        class="anchor"
        aria-label="Permalink: External libs"
        href="#external-libs"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <div class="markdown-heading">
      <h3 class="heading-element">No need <code>go mod vendor</code></h3>
      <a
        id="user-content-no-need-go-mod-vendor"
        class="anchor"
        aria-label="Permalink: No need go mod vendor"
        href="#no-need-go-mod-vendor"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <p>Save storage space.</p>
    <div class="markdown-heading">
      <h3 class="heading-element">
        Use <a href="https://github.com/bufbuild/buf">bufbuild/buf</a> for proto
        related
      </h3>
      <a
        id="user-content-use-bufbuildbuf-for-proto-related"
        class="anchor"
        aria-label="Permalink: Use bufbuild/buf for proto related"
        href="#use-bufbuildbuf-for-proto-related"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <p>
      Please don't use
      <a href="https://github.com/grpc-ecosystem/grpc-gateway"
        >grpc-ecosystem/grpc-gateway</a
      >:
    </p>
    <ul>
      <li>Can not upload files</li>
    </ul>
    <div class="markdown-heading">
      <h3 class="heading-element">
        Use <a href="https://github.com/gin-gonic/gin">gin-gonic/gin</a> for
        HTTP framework
      </h3>
      <a
        id="user-content-use-gin-gonicgin-for-http-framework"
        class="anchor"
        aria-label="Permalink: Use gin-gonic/gin for HTTP framework"
        href="#use-gin-gonicgin-for-http-framework"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <p>With <code>c *gin.Context</code>:</p>
    <ul>
      <li>
        Don't use <code>c</code> when passing context, use
        <code>c.Request.Context()</code> instead
      </li>
      <li>
        Don't use <code>c.Request.URL.Path</code>, use
        <code>c.FullPath()</code> instead
      </li>
    </ul>
    <p>Remember to free resources after parse multipart form:</p>
    <div class="highlight highlight-source-go">
      <pre><span class="pl-k">defer</span> <span class="pl-k">func</span>() {
    <span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">c</span>.<span class="pl-c1">Request</span>.<span class="pl-c1">MultipartForm</span>.<span class="pl-c1">RemoveAll</span>(); <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
        <span class="pl-c">// Handle error</span>
    }
}()</pre>
    </div>
    <p>
      Combine with
      <a href="https://github.com/go-playground/validator"
        >go-playground/validator</a
      >
      to validate request structs.
    </p>
    <div class="markdown-heading">
      <h3 class="heading-element">
        Log with <a href="https://github.com/uber-go/zap">uber-go/zap</a>
      </h3>
      <a
        id="user-content-log-with-uber-gozap"
        class="anchor"
        aria-label="Permalink: Log with uber-go/zap"
        href="#log-with-uber-gozap"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <p>It is fast!</p>
    <ul>
      <li>
        Use <code>MarshalLogObject</code> when need to hide PII or long fields
      </li>
      <li>Prefer <code>DPanic</code> to <code>Panic</code></li>
      <li>Use <code>Fatal</code> when init service</li>
      <li>If doubt, use <code>zap.Any</code></li>
    </ul>
    <div class="markdown-heading">
      <h3 class="heading-element">
        Read config with
        <a href="https://github.com/spf13/viper">spf13/viper</a>
      </h3>
      <a
        id="user-content-read-config-with-spf13viper"
        class="anchor"
        aria-label="Permalink: Read config with spf13/viper"
        href="#read-config-with-spf13viper"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <p>
      Only init config in main or cmd layer. Do not use
      <code>viper.Get...</code> in inside layer.
    </p>
    <p>Why?</p>
    <ul>
      <li>Hard to mock and test</li>
      <li>Put all config in single place for easily tracking</li>
    </ul>
    <p>
      Also, be careful if config value is empty. You should decide to continue
      or stop the service if there is empty config.
    </p>
    <div class="markdown-heading">
      <h3 class="heading-element">
        Connect database with
        <a href="https://github.com/go-gorm/gorm">go-gorm/gorm</a>
      </h3>
      <a
        id="user-content-connect-database-with-go-gormgorm"
        class="anchor"
        aria-label="Permalink: Connect database with go-gorm/gorm"
        href="#connect-database-with-go-gormgorm"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <p>
      Make sure to test your code (ORM or not) with
      <a href="https://github.com/DATA-DOG/go-sqlmock">DATA-DOG/go-sqlmock</a>.
    </p>
    <div class="markdown-heading">
      <h3 class="heading-element">
        Connect Redis with
        <a href="https://github.com/redis/go-redis">redis/go-redis</a>
      </h3>
      <a
        id="user-content-connect-redis-with-redisgo-redis"
        class="anchor"
        aria-label="Permalink: Connect Redis with redis/go-redis"
        href="#connect-redis-with-redisgo-redis"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <p>
      Be careful when use
      <a href="https://redis.io/docs/latest/commands/hgetall//" rel="nofollow"
        >HGETALL</a
      >. If key not found, empty data will be returned not nil error. See
      <a href="https://github.com/redis/go-redis/issues/1668"
        >redis/go-redis/issues/1668</a
      >
    </p>
    <p>
      Use
      <a
        href="https://redis.uptrace.dev/guide/go-redis-pipelines.html"
        rel="nofollow"
        >Pipelines</a
      >
      for:
    </p>
    <ul>
      <li>HSET and EXPIRE in 1 command</li>
    </ul>
    <p>Prefer <code>Pipelined</code> to <code>Pipeline</code>.</p>
    <p>Example:</p>
    <div class="highlight highlight-source-go">
      <pre><span class="pl-k">func</span> (<span class="pl-s1">c</span> <span class="pl-c1">*</span><span class="pl-smi">client</span>) <span class="pl-c1">HSetWithExpire</span>(<span class="pl-s1">ctx</span> context.<span class="pl-smi">Context</span>, <span class="pl-s1">key</span> <span class="pl-smi">string</span>, <span class="pl-s1">values</span> []<span class="pl-smi">any</span>, <span class="pl-s1">expired</span> time.<span class="pl-smi">Duration</span>) <span class="pl-smi">error</span> {
	<span class="pl-s1">cmds</span> <span class="pl-c1">:=</span> <span class="pl-s1">make</span>([]redis.<span class="pl-smi">Cmder</span>, <span class="pl-c1">2</span>)

	<span class="pl-k">if</span> <span class="pl-s1">_</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">c</span>.<span class="pl-c1">Pipelined</span>(<span class="pl-s1">ctx</span>, <span class="pl-k">func</span>(<span class="pl-s1">pipe</span> redis.<span class="pl-smi">Pipeliner</span>) <span class="pl-smi">error</span> {
		<span class="pl-s1">cmds</span>[<span class="pl-c1">0</span>] <span class="pl-c1">=</span> <span class="pl-s1">pipe</span>.<span class="pl-c1">HSet</span>(<span class="pl-s1">ctx</span>, <span class="pl-s1">key</span>, <span class="pl-s1">values</span><span class="pl-c1">...</span>)

		<span class="pl-k">if</span> <span class="pl-s1">expired</span> <span class="pl-c1">&gt;</span> <span class="pl-c1">0</span> {
			<span class="pl-s1">cmds</span>[<span class="pl-c1">1</span>] <span class="pl-c1">=</span> <span class="pl-s1">pipe</span>.<span class="pl-c1">Expire</span>(<span class="pl-s1">ctx</span>, <span class="pl-s1">key</span>, <span class="pl-s1">expired</span>)
		}

		<span class="pl-k">return</span> <span class="pl-c1">nil</span>
	}); <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
		<span class="pl-k">return</span> <span class="pl-s1">err</span>
	}

	<span class="pl-k">for</span> <span class="pl-s1">_</span>, <span class="pl-s1">cmd</span> <span class="pl-c1">:=</span> <span class="pl-k">range</span> <span class="pl-s1">cmds</span> {
		<span class="pl-k">if</span> <span class="pl-s1">cmd</span> <span class="pl-c1">==</span> <span class="pl-c1">nil</span> {
			<span class="pl-k">continue</span>
		}

		<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">cmd</span>.<span class="pl-c1">Err</span>(); <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
			<span class="pl-k">return</span> <span class="pl-s1">err</span>
		}
	}

	<span class="pl-k">return</span> <span class="pl-c1">nil</span>
}</pre>
    </div>
    <p>Remember to config:</p>
    <ul>
      <li><code>ReadTimeout</code></li>
      <li><code>WriteTimeout</code></li>
      <li><code>ContextTimeoutEnabled</code> to true</li>
      <li><code>Protocol</code> to <code>3</code></li>
      <li><code>DisableIdentity</code> to true</li>
    </ul>
    <div class="markdown-heading">
      <h3 class="heading-element">
        Connect MySQL with
        <a href="https://github.com/go-sql-driver/mysql">go-sql-driver/mysql</a>
      </h3>
      <a
        id="user-content-connect-mysql-with-go-sql-drivermysql"
        class="anchor"
        aria-label="Permalink: Connect MySQL with go-sql-driver/mysql"
        href="#connect-mysql-with-go-sql-drivermysql"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <p>Remember to config:</p>
    <ul>
      <li><code>SetConnMaxLifetime</code></li>
      <li><code>SetMaxOpenConns</code></li>
      <li><code>SetMaxIdleConns</code></li>
      <li><code>ParseTime</code> to true.</li>
      <li><code>Loc</code> to <code>time.UTC</code>.</li>
      <li><code>CheckConnLiveness</code> to true.</li>
      <li><code>ReadTimeout</code>, <code>WriteTimeout</code></li>
    </ul>
    <div class="markdown-heading">
      <h3 class="heading-element">
        Connect Kafka with
        <a href="https://github.com/IBM/sarama">IBM/sarama</a>
      </h3>
      <a
        id="user-content-connect-kafka-with-ibmsarama"
        class="anchor"
        aria-label="Permalink: Connect Kafka with IBM/sarama"
        href="#connect-kafka-with-ibmsarama"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <p>
      Don't use
      <a href="https://github.com/confluentinc/confluent-kafka-go"
        >confluentinc/confluent-kafka-go</a
      >, because it's required <code>CGO_ENABLED</code>.
    </p>
    <div class="markdown-heading">
      <h3 class="heading-element">
        Test with
        <a href="https://github.com/stretchr/testify">stretchr/testify</a>
      </h3>
      <a
        id="user-content-test-with-stretchrtestify"
        class="anchor"
        aria-label="Permalink: Test with stretchr/testify"
        href="#test-with-stretchrtestify"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <p>
      It is easy to write a suite test, thanks to testify. Also, for mocking,
      there are many options out there. Pick 1 then sleep peacefully.
    </p>
    <div class="markdown-heading">
      <h3 class="heading-element">
        Mock with <a href="https://github.com/matryer/moq">matryer/moq</a> or
        <a href="https://github.com/uber/mock">uber/mock</a>
      </h3>
      <a
        id="user-content-mock-with-matryermoq-or-ubermock"
        class="anchor"
        aria-label="Permalink: Mock with matryer/moq or uber/mock"
        href="#mock-with-matryermoq-or-ubermock"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <p>
      The first is easy to use but not powerful as the later. If you want to
      make sure mock func is called with correct times, use the later.
    </p>
    <p>Example with <code>matryer/moq</code>:</p>
    <div class="highlight highlight-source-go">
      <pre><span class="pl-c">// Only gen mock if source code file is newer than mock file</span>
<span class="pl-c">// https://jonwillia.ms/2019/12/22/conditional-gomock-mockgen</span>
<span class="pl-c">//go:generate sh -c "test service_mock_generated.go -nt $GOFILE &amp;&amp; exit 0; moq -rm -out service_mock_generated.go . Service"</span></pre>
    </div>
    <div class="markdown-heading">
      <h3 class="heading-element">
        Replace <code>go fmt</code> with
        <a href="https://github.com/mvdan/gofumpt">mvdan/gofumpt</a>
      </h3>
      <a
        id="user-content-replace-go-fmt-with-mvdangofumpt"
        class="anchor"
        aria-label="Permalink: Replace go fmt with mvdan/gofumpt"
        href="#replace-go-fmt-with-mvdangofumpt"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <p><code>gofumpt</code> provides more strict rules when format Go codes.</p>
    <div class="highlight highlight-source-shell">
      <pre>gofumpt -w -extra <span class="pl-c1">.</span></pre>
    </div>
    <div class="markdown-heading">
      <h3 class="heading-element">
        Use
        <a href="https://github.com/golangci/golangci-lint"
          >golangci/golangci-lint</a
        >
      </h3>
      <a
        id="user-content-use-golangcigolangci-lint"
        class="anchor"
        aria-label="Permalink: Use golangci/golangci-lint"
        href="#use-golangcigolangci-lint"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <p>No need to say more. Lint is the way!</p>
    <p>
      Use fieldalignment for performance: pointer -&gt; string -&gt; []byte
      -&gt; int64/float64 -&gt; int32/float32 -&gt; bool.
    </p>
    <div class="highlight highlight-source-shell">
      <pre>golangci-lint run --fix --no-config ./...</pre>
    </div>
    <div class="markdown-heading">
      <h2 class="heading-element">Scripts</h2>
      <a
        id="user-content-scripts"
        class="anchor"
        aria-label="Permalink: Scripts"
        href="#scripts"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <p>Change import:</p>
    <div class="highlight highlight-source-shell">
      <pre>gofmt -w -r <span class="pl-s"><span class="pl-pds">'</span>"github.com/Sirupsen/logrus" -&gt; "github.com/sirupsen/logrus"<span class="pl-pds">'</span></span> <span class="pl-k">*</span>.go</pre>
    </div>
    <p>Cleanup if storage is full:</p>
    <div class="highlight highlight-source-shell">
      <pre>go clean -cache -testcache -modcache -fuzzcache -x</pre>
    </div>
    <div class="markdown-heading">
      <h2 class="heading-element">Thanks</h2>
      <a
        id="user-content-thanks"
        class="anchor"
        aria-label="Permalink: Thanks"
        href="#thanks"
        ><span aria-hidden="true" class="octicon octicon-link"></span
      ></a>
    </div>
    <ul>
      <li>
        <a href="https://github.com/uber-go/guide/blob/master/style.md"
          >Uber Go Style Guide</a
        >
      </li>
      <li>
        <a
          href="https://github.com/tigerbeetle/tigerbeetle/blob/main/docs/TIGER_STYLE.md"
          >TigerStyle</a
        >
      </li>
    </ul>

    <div>
      <br />Source code is available on
      <a href="https://github.com/haunt98/posts-go">GitHub</a>
    </div>
  </body>
</html>
